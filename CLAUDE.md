# Claude Code REST API

REST API wrapper for Claude Code CLI. Exposes HTTP endpoints for session management and query execution.

## Commands

```bash
npm run dev          # Development server with auto-reload (port 3000)
npm run build        # TypeScript compilation to dist/
npm start            # Production server
npm test             # Run all tests
npm run test:unit    # Unit tests only
npm run test:watch   # Watch mode for TDD
```

## Architecture

3-layer architecture: Routes → Services → Infrastructure

```
src/
├── routes/          # HTTP endpoints (sessions.ts, query.ts, health.ts)
├── services/        # Business logic (SessionService, QueryService)
├── infrastructure/  # CLIExecutor, SessionStore (SQLite), RequestQueue (p-queue)
├── middleware/      # Express middleware (validation, error handling)
├── types/           # TypeScript definitions
└── utils/           # CLI args builder, stream parser, logger
```

## Key Files

- `src/infrastructure/CLIExecutor.ts` - Spawns `claude` CLI processes, handles blocking and streaming
- `src/infrastructure/SessionStore.ts` - SQLite session persistence (better-sqlite3)
- `src/services/SessionService.ts` - Session CRUD, message handling with per-session queue
- `src/utils/cliArgs.ts` - Maps API request options to CLI flags

## Critical Requirements

- **Node.js 20 required** - better-sqlite3 native bindings need Node 20 LTS
- **Claude CLI must be installed and authenticated** - check with `claude --version`

## Code Patterns

- ESM modules (`"type": "module"` in package.json)
- Strict TypeScript with `noUnusedLocals`, `noUnusedParameters`
- Zod for request validation
- Winston for logging
- Vitest + Supertest for testing

## Testing

Unit tests mock CLIExecutor to avoid actual CLI calls. Integration tests use supertest against Express app.

```
tests/
├── unit/            # Mock-based tests for services/infrastructure
├── integration/     # HTTP endpoint tests with mocked CLI
└── e2e/             # (empty - would need real CLI)
```

## Gotchas

- CLI path is auto-detected (looks for `claude` in PATH, then common locations)
- SSE streaming parses NDJSON from `--output-format=stream-json`
- Session IDs come from CLI's `--session-id` flag, not generated by API
- Per-session queue ensures sequential message processing (p-queue)
- SQLite uses WAL mode for concurrent access
